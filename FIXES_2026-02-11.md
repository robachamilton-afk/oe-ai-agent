# OE AI Agent - Critical Fixes (February 11, 2026)

## Summary

Fixed multiple critical issues preventing the AI agent from functioning correctly. The agent can now successfully query project data, maintain conversation history, and execute tool calls without errors.

---

## Issues Fixed

### 1. Tool Calls Format Error
**Error**: `"Invalid parameter: messages with role 'tool' must be a response to a preceding message with 'tool_calls'"`

**Root Causes**:
- Message ordering issue when loading conversation history from database
- Tool response messages with NULL content
- Messages with identical timestamps being loaded in undefined order

**Fixes**:
- **Commit `37a7539`**: Added secondary sort by `id` in `getRecentMessages()` to ensure correct message order when timestamps are identical
- **Commit `78ea48d`**: Added null content handling in both `agent-orchestrator.ts` and `conversation-manager.ts`
  - Tool results now default to `{"error":"Tool returned no result"}` instead of NULL
  - `buildLLMContext()` converts NULL content to empty string for non-tool messages

---

### 2. SQL Query Failures
**Error**: Tools returning no results despite data existing in database

**Root Causes**:
- **SQL Syntax Error**: Using `AND` instead of `WHERE` in query construction
- **Wrong Table Names**: Looking for `proj_{id}_red_flags` when actual table is `proj_{id}_redFlags` (camelCase)
- **Wrong Column Names**: Using snake_case column names when database uses camelCase for documents and redFlags tables

**Fixes**:
- **Commit `0bc4a79`**: Fixed SQL syntax error in `query_facts` tool (AND → WHERE)
- **Commit `0cf55ce`**: Fixed table name from `red_flags` to `redFlags` (camelCase)
- **Commit `c99442d`**: Comprehensive schema audit - fixed ALL column names:

#### Column Name Fixes

**query_documents** (documents table uses camelCase):
```typescript
// BEFORE (wrong)
SELECT id, file_name, document_type, status, page_count, upload_date

// AFTER (correct)
SELECT id, fileName, documentType, status, pageCount, uploadDate
```

**query_red_flags** (redFlags table uses camelCase):
```typescript
// BEFORE (wrong)
SELECT id, category, title, description, severity, 
       trigger_fact_id, downstream_consequences, mitigated, created_at

// AFTER (correct)
SELECT id, category, title, description, severity, 
       triggerFactId, downstreamConsequences, mitigated, createdAt
```

**get_fact_by_id**:
```typescript
// BEFORE (wrong)
SELECT ef.*, d.file_name as source_document_name

// AFTER (correct)
SELECT ef.*, d.fileName as source_document_name
```

**get_project_summary**:
```typescript
// BEFORE (wrong)
SELECT document_type, COUNT(*) as count FROM documents GROUP BY document_type

// AFTER (correct)
SELECT documentType, COUNT(*) as count FROM documents GROUP BY documentType
```

---

### 3. Database Schema Inconsistency

The database uses **mixed naming conventions**:

| Table | Convention | Example Columns |
|-------|-----------|-----------------|
| `proj_{id}_extracted_facts` | snake_case | `project_id`, `data_type`, `source_document_id`, `created_at` |
| `proj_{id}_documents` | camelCase | `fileName`, `documentType`, `pageCount`, `uploadDate` |
| `proj_{id}_redFlags` | camelCase | `triggerFactId`, `downstreamConsequences`, `createdAt` |

**Solution**: Query tools now use the correct naming convention for each table.

---

## Debugging Enhancements

Added comprehensive logging throughout the codebase:

**agent-orchestrator.ts**:
- Logs tool count and names before LLM invocation
- Logs message array before each LLM call
- Logs tool execution arguments and results

**query-tools.ts**:
- Logs query arguments, context, and generated SQL
- Logs query results and row counts
- Logs errors with full stack traces

**Logging commits**:
- `4cb1f10`: Added initial debug logging
- `79f87c9`: Added query_facts detailed logging
- `15ab0a6`: Added tool registration logging
- `5f00459`: Fixed tool name logging format

---

## Files Modified

### Core Files
- `src/agent-orchestrator.ts` - Message handling, tool execution, logging
- `src/conversation-manager.ts` - Message ordering, null content handling
- `src/tools/query-tools.ts` - SQL queries, table/column names

### Supporting Files
- `src/llm.ts` - Message normalization (from earlier fixes)

---

## Testing Checklist

After deploying commit `c99442d`, verify the following work correctly:

- [ ] **Query Facts**: "What is the DC capacity of the project?"
- [ ] **Query Facts**: "What is the project name?"
- [ ] **Query Documents**: "How many documents have been uploaded?"
- [ ] **Query Documents**: "List all documents"
- [ ] **Query Red Flags**: "Show me high-severity red flags"
- [ ] **Project Summary**: "Summarize the key facts extracted so far"
- [ ] **Conversation History**: Multiple questions in same conversation without errors
- [ ] **Tool Calls**: No "tool must follow tool_calls" errors

---

## Deployment

**Latest Commit**: `c99442d`

**Deployment Command**:
```bash
git pull origin master
# Restart application server
```

**Verify Deployment**:
```bash
git log --oneline -1
# Should show: c99442d fix: comprehensive schema audit - fix ALL column names to match database
```

---

## Future Recommendations

### Short-term
1. Add integration tests for all query tools
2. Add schema validation on application startup
3. Implement database connection health checks

### Long-term
1. **Standardize database naming convention** - Choose either snake_case OR camelCase consistently across all tables
2. **Use an ORM with schema validation** - Drizzle ORM with proper schema definitions would catch these mismatches at compile time
3. **Add database migration versioning** - Track schema changes with migration scripts
4. **Implement query builders** - Reduce raw SQL to minimize naming errors

---

## Commit History

| Commit | Date | Description |
|--------|------|-------------|
| `c99442d` | 2026-02-11 | Comprehensive schema audit - fix ALL column names |
| `0bc4a79` | 2026-02-11 | Fix SQL syntax error (AND → WHERE) |
| `0cf55ce` | 2026-02-11 | Fix table name (red_flags → redFlags) |
| `5f00459` | 2026-02-11 | Fix tool name logging format |
| `15ab0a6` | 2026-02-11 | Add tool registration logging |
| `79f87c9` | 2026-02-11 | Add query_facts detailed logging |
| `4cb1f10` | 2026-02-11 | Add comprehensive debug logging |
| `37a7539` | 2026-02-11 | Fix message ordering with secondary sort |
| `78ea48d` | 2026-02-11 | Fix null content handling and table names |
| `fcc8c91` | 2026-02-11 | Fix Drizzle INSERT bug with optional fields |
| `5a5746d` | 2026-02-11 | Fix tool_calls preservation in message history |

---

## Contact

For issues or questions, refer to the main project documentation or contact the development team.
